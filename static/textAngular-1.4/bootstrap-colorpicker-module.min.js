"use strict";angular.module("colorpicker.module",[]).factory("Helper",function(){return{closestSlider:function(e){var t=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;return t.bind(e)("I")?e.parentNode:e},getOffset:function(e){for(var t=0,o=0,r=0,n=0;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft,o+=e.offsetTop,r+=e.scrollLeft,n+=e.scrollTop,e=e.offsetParent;return{top:o,left:t,scrollX:r,scrollY:n}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(e){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,t,o,r){e/=255,t/=255,o/=255;var n,i,a,l;return a=Math.max(e,t,o),l=a-Math.min(e,t,o),n=0===l?null:a==e?(t-o)/l:a==t?(o-e)/l+2:(e-t)/l+4,n=(n+360)%6*60/360,i=0===l?0:l/a,{h:n||1,s:i,b:a,a:r||1}},setColor:function(t){t=t.toLowerCase();for(var o in e.stringParsers)if(e.stringParsers.hasOwnProperty(o)){var r=e.stringParsers[o],n=r.re.exec(t),i=n&&r.parse(n);r.space||"rgba";if(i)return this.value=this.RGBtoHSB.apply(null,i),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,t,o,r){e||(e=this.value.h,t=this.value.s,o=this.value.b),e*=360;var n,i,a,l,s;return e=e%360/60,s=o*t,l=s*(1-Math.abs(e%2-1)),n=i=a=o-s,e=~~e,n+=[s,l,0,0,l,s][e],i+=[l,s,s,l,0,0][e],a+=[0,0,l,s,s,l][e],{r:Math.round(255*n),g:Math.round(255*i),b:Math.round(255*a),a:r||this.value.a}},toHex:function(e,t,o,r){var n=this.toRGB(e,t,o,r);return"#"+(1<<24|parseInt(n.r,10)<<16|parseInt(n.g,10)<<8|parseInt(n.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(e){var t={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},o={};return{getSlider:function(){return t},getLeftPosition:function(e){return Math.max(0,Math.min(t.maxLeft,t.left+((e.pageX||o.left)-o.left)))},getTopPosition:function(e){return Math.max(0,Math.min(t.maxTop,t.top+((e.pageY||o.top)-o.top)))},setSlider:function(r){var n=e.closestSlider(r.target),i=e.getOffset(n);t.knob=n.children[0].style,t.left=r.pageX-i.left-window.pageXOffset+i.scrollX,t.top=r.pageY-i.top-window.pageYOffset+i.scrollY,o={left:r.pageX,top:r.pageY}},setSaturation:function(e){t={maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e)},setHue:function(e){t={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"},this.setSlider(e)},setAlpha:function(e){t={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"},this.setSlider(e)},setKnob:function(e,o){t.knob.top=e+"px",t.knob.left=o+"px"}}}]).directive("colorpicker",["$document","$compile","$timeout","Color","Slider","Helper",function(e,t,o,r,n,i){return{require:"?ngModel",restrict:"A",link:function(a,l,s,c){function u(){return k?'<div><div class="pickerVal">{{selectedColor}}</div><div class="addHex"><button type="button" ng-click="customColor()" class="btn btn-primary">Add HEX value</button></div></div>':g?'<input type="text" name="colorpicker-input">':""}var p,f=s.colorpicker?s.colorpicker:"hex",d=angular.isDefined(s.colorpickerPosition)?s.colorpickerPosition:"bottom",v=angular.isDefined(s.colorpickerFixedPosition)?s.colorpickerFixedPosition:!1,h=angular.isDefined(s.colorpickerParent)?l.parent():angular.element(document.body),g=angular.isDefined(s.colorpickerWithInput)?s.colorpickerWithInput:!1,k=angular.isDefined(s.colorpickerTextEditor)?s.colorpickerTextEditor:!1,m=u(),b='<div class="colorpicker dropdown"><div class="dropdown-menu"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+m+'<button class="close close-colorpicker">&times;</button></div></div>',x=angular.element(b),w=r,C=x.find("colorpicker-hue"),H=x.find("colorpicker-saturation"),S=x.find("colorpicker-preview"),P=x.find("i");if(a.customColor=function(){var e;e=prompt("Please enter a HEX value","#"),""!==e&&(l.val(e),a.action(e))},t(x)(a),g){var L=x.find("input");L.on("mousedown",function(){event.stopPropagation()}).on("keyup",function(e){var t=this.value;l.val(t),c&&a.$apply(c.$setViewValue(t)),e.stopPropagation(),e.preventDefault()}),l.on("keyup",function(){L.val(l.val())})}var T=function(){e.on("mousemove",M),e.on("mouseup",A)};"rgba"===f&&(x.addClass("alpha"),p=x.find("colorpicker-alpha"),p.on("click",function(e){n.setAlpha(e),M(e)}).on("mousedown",function(e){n.setAlpha(e),T()})),C.on("click",function(e){n.setHue(e),M(e)}).on("mousedown",function(e){n.setHue(e),T()}),H.on("click",function(e){n.setSaturation(e),M(e)}).on("mousedown",function(e){n.setSaturation(e),T()}),v&&x.addClass("colorpicker-fixed-position"),x.addClass("colorpicker-position-"+d),h.append(x),c&&(c.$render=function(){l.val(c.$viewValue)},a.$watch(s.ngModel,function(){I()})),l.on("$destroy",function(){x.remove()});var y=function(){try{S.css("backgroundColor",w[f]())}catch(e){S.css("backgroundColor",w.toHex())}H.css("backgroundColor",w.toHex(w.value.h,1,1,1)),"rgba"===f&&(p.css.backgroundColor=w.toHex()),k&&o(function(){a.selectedColor=w.toHex()})},M=function(e){var t=n.getLeftPosition(e),o=n.getTopPosition(e),r=n.getSlider();n.setKnob(o,t),r.callLeft&&w[r.callLeft].call(w,t/100),r.callTop&&w[r.callTop].call(w,o/100),y();var i=w[f]();return l.val(i),c&&a.$apply(c.$setViewValue(i)),g&&L.val(i),k&&(a.selectedColor=i),!1},A=function(){e.off("mousemove",M),e.off("mouseup",A),k&&a.action(a.selectedColor)},I=function(){w.setColor(l.val()),P.eq(0).css({left:100*w.value.s+"px",top:100-100*w.value.b+"px"}),P.eq(1).css("top",100*(1-w.value.h)+"px"),P.eq(2).css("top",100*(1-w.value.a)+"px"),y()},$=function(){var e,t=i.getOffset(l[0]);return angular.isDefined(s.colorpickerParent)&&(t.left=0,t.top=0),"top"===d?e={top:t.top-147,left:t.left}:"right"===d?e={top:t.top,left:t.left+126}:"bottom"===d?e={top:t.top+l[0].offsetHeight+2,left:t.left}:"left"===d&&(e={top:t.top,left:t.left-150}),{top:e.top+"px",left:e.left+"px"}};l.on("click",function(){I(),x.addClass("colorpicker-visible").css($())}),x.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()});var B=function(){x.hasClass("colorpicker-visible")&&x.removeClass("colorpicker-visible")};x.find("button").on("click",function(){B()}),e.on("mousedown",function(){B()})}}}]);